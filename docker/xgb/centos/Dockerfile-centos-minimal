ARG FROM_IMAGE
FROM ${FROM_IMAGE}

MAINTAINER h2oai "h2o.ai"

ARG H2O_BRANCH='master'
ARG JENKINS_UID='2117'
ARG JENKINS_GID='2117'

COPY xgb/centos/common/sbin xgb/common/sbin /usr/sbin/

RUN \
    chmod +x /usr/sbin/install_packages && \
    sync && \
    /usr/sbin/install_packages

RUN \
    chmod +x /usr/sbin/install_java && \
    sync && \
    /usr/sbin/install_java
ENV JAVA_VERSION='8' \
    JAVA_HOME=/usr/lib/jvm/java-8-oracle \
    PATH=/usr/lib/jvm/java-8-oracle/bin:${PATH}

RUN \
    chmod +x /usr/sbin/install_python && \
    sync && \
    /usr/sbin/install_python

RUN \
    chmod +x /usr/sbin/create_jenkins_user && \
    sync && \
    /usr/sbin/create_jenkins_user

# Install s3cmd
ENV S3_CMD_VERSION '2.0.1'
RUN \
    cd /opt/ && \
    wget http://netix.dl.sourceforge.net/project/s3tools/s3cmd/${S3_CMD_VERSION}/s3cmd-${S3_CMD_VERSION}.tar.gz && \
    tar xvzf s3cmd-${S3_CMD_VERSION}.tar.gz && \
    cd s3cmd-${S3_CMD_VERSION} && \
    python setup.py install

ENV LANG 'en_US.UTF-8'
ENV LC_ALL 'en_US.UTF-8'

COPY xgb/common/tmp/prepare_gradle_caches /tmp/
RUN \
    chmod +x /tmp/prepare_gradle_caches && \
    chown jenkins:jenkins /tmp/prepare_gradle_caches
USER jenkins
RUN \
    /tmp/prepare_gradle_caches

USER root

RUN \
    yum remove -y libgomp

ENTRYPOINT /bin/bash